"""Tests for blend_scanner.scanners.malware module."""

import pytest

from blend_scanner.models import Severity
from blend_scanner.scanners.malware import MalwareScanner


class TestMalwareScannerProperties:
    """Tests for MalwareScanner properties."""

    def test_scanner_name(self, malware_scanner):
        """Test scanner name property."""
        assert malware_scanner.name == "malware"

    def test_scanner_description(self, malware_scanner):
        """Test scanner description property."""
        assert "dangerous code patterns" in malware_scanner.description.lower()


class TestMalwareScannerDangerousPatterns:
    """Tests for dangerous pattern detection (ERROR level)."""

    @pytest.mark.parametrize(
        "code,pattern_name",
        [
            ("os.system('ls')", "os.system"),
            ("result = os.popen('cmd')", "os.popen"),
            ("import subprocess", "subprocess"),
            ("subprocess.call(['ls'])", "subprocess"),
            ("exec('print(1)')", "exec"),
            ("socket.socket()", "socket"),
            ("requests.get(url)", "requests"),
            ("urllib.request.urlopen(url)", "urllib"),
            ("shutil.rmtree('/path')", "shutil.rmtree"),
            ("mod = __import__('os')", "__import__"),
        ],
    )
    def test_dangerous_pattern_detected(self, malware_scanner, code, pattern_name):
        """Test that dangerous patterns are detected as errors."""
        findings = malware_scanner.scan(code, "test.py")
        assert len(findings) >= 1
        assert any(f.severity == Severity.ERROR for f in findings)
        assert any(pattern_name in f.message for f in findings)

    def test_os_system_detection(self, malware_scanner):
        """Test os.system detection with details."""
        code = "os.system('rm -rf /')"
        findings = malware_scanner.scan(code, "script.py")
        assert len(findings) == 1
        finding = findings[0]
        assert finding.scanner == "malware"
        assert finding.severity == Severity.ERROR
        assert "os.system" in finding.message
        assert finding.location == "script.py:1"
        assert "os.system" in finding.matched_text

    def test_multiple_dangerous_patterns_same_line(self, malware_scanner):
        """Test detecting multiple patterns on the same line."""
        code = "os.system(subprocess.getoutput('cmd'))"
        findings = malware_scanner.scan(code, "test.py")
        assert len(findings) == 2
        patterns = [f.message for f in findings]
        assert any("os.system" in p for p in patterns)
        assert any("subprocess" in p for p in patterns)


class TestMalwareScannerWarningPatterns:
    """Tests for warning pattern detection (WARNING level)."""

    def test_eval_detection(self, malware_scanner):
        """Test eval() detection as warning."""
        code = "result = eval('1 + 2')"
        findings = malware_scanner.scan(code, "test.py")
        assert len(findings) == 1
        assert findings[0].severity == Severity.WARNING
        assert "eval" in findings[0].message
        assert "Rigify" in findings[0].message  # Mentions legitimate use

    def test_eval_not_error(self, malware_scanner):
        """Test that eval is warning, not error."""
        code = "eval(expression)"
        findings = malware_scanner.scan(code, "test.py")
        assert all(f.severity == Severity.WARNING for f in findings)


class TestMalwareScannerSafeCode:
    """Tests for safe code (no findings)."""

    def test_safe_code_no_findings(self, malware_scanner, safe_code):
        """Test that safe code produces no findings."""
        findings = malware_scanner.scan(safe_code, "safe.py")
        assert len(findings) == 0

    def test_similar_but_safe_patterns(self, malware_scanner):
        """Test that similar but safe patterns are not flagged."""
        safe_patterns = [
            "system_config = 'test'",  # Not os.system
            "my_socket = 5",  # Not socket.
            "# os.system is dangerous",  # Comment
            'print("requests library")',  # String mention
        ]
        for code in safe_patterns:
            findings = malware_scanner.scan(code, "test.py")
            # Some might match (like comment with os.system), verify they're reasonable
            if len(findings) > 0:
                # Comments should still match since they contain the pattern
                assert "os.system" in code or "socket." in code


class TestMalwareScannerMultiline:
    """Tests for multiline code scanning."""

    def test_multiline_code(self, malware_scanner, malicious_code):
        """Test scanning multiline code with multiple issues."""
        findings = malware_scanner.scan(malicious_code, "malicious.py")
        # Should detect: os.system, os.popen, subprocess (x2), exec, eval, __import__
        assert len(findings) >= 6

        error_findings = [f for f in findings if f.severity == Severity.ERROR]
        warning_findings = [f for f in findings if f.severity == Severity.WARNING]

        assert len(error_findings) >= 5
        assert len(warning_findings) >= 1

    def test_line_numbers_correct(self, malware_scanner):
        """Test that line numbers are correctly reported."""
        code = """line 1
line 2
os.system('test')
line 4"""
        findings = malware_scanner.scan(code, "test.py")
        assert len(findings) == 1
        assert findings[0].location == "test.py:3"


class TestMalwareScannerScanMultiple:
    """Tests for scan_multiple method."""

    def test_scan_multiple_contents(self, malware_scanner):
        """Test scanning multiple content blocks."""
        contents = {
            "script1.py": "os.system('ls')",
            "script2.py": "safe code here",
            "script3.py": "subprocess.run(['cmd'])",
        }
        findings = malware_scanner.scan_multiple(contents)
        assert len(findings) == 2

        locations = [f.location for f in findings]
        assert any("script1.py" in loc for loc in locations)
        assert any("script3.py" in loc for loc in locations)

    def test_scan_multiple_empty(self, malware_scanner):
        """Test scanning empty contents."""
        findings = malware_scanner.scan_multiple({})
        assert len(findings) == 0
