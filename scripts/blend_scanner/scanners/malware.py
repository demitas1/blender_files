"""Malware pattern scanner for detecting dangerous code patterns."""

import re

from blend_scanner.models import Finding, Severity
from blend_scanner.scanners.base import BaseScanner


class MalwareScanner(BaseScanner):
    """Scanner for detecting malware-like patterns in code."""

    # Dangerous patterns (error level)
    DANGEROUS_PATTERNS = [
        (r"os\.system", "os.system: Shell command execution"),
        (r"os\.popen", "os.popen: Shell command execution with pipe"),
        (r"subprocess", "subprocess: Process spawning"),
        (r"exec\(", "exec(): Dynamic code execution"),
        (r"socket\.", "socket: Network connection"),
        (r"requests\.", "requests: HTTP communication"),
        (r"urllib\.", "urllib: URL/HTTP operations"),
        (r"shutil\.rmtree", "shutil.rmtree: Recursive directory deletion"),
        (r"__import__", "__import__: Dynamic module import"),
    ]

    # Warning patterns (need review)
    WARNING_PATTERNS = [
        (r"eval\(", "eval(): Dynamic expression evaluation (may be legitimate in Rigify)"),
    ]

    @property
    def name(self) -> str:
        return "malware"

    @property
    def description(self) -> str:
        return "Detects dangerous code patterns that could indicate malware"

    def scan(self, content: str, source: str) -> list[Finding]:
        """Scan content for malware patterns."""
        findings = []

        for line_no, line in enumerate(content.split("\n"), 1):
            # Check dangerous patterns
            for pattern, message in self.DANGEROUS_PATTERNS:
                if re.search(pattern, line):
                    findings.append(
                        Finding(
                            scanner=self.name,
                            severity=Severity.ERROR,
                            message=message,
                            location=f"{source}:{line_no}",
                            matched_text=line.strip(),
                        )
                    )

            # Check warning patterns
            for pattern, message in self.WARNING_PATTERNS:
                if re.search(pattern, line):
                    findings.append(
                        Finding(
                            scanner=self.name,
                            severity=Severity.WARNING,
                            message=message,
                            location=f"{source}:{line_no}",
                            matched_text=line.strip(),
                        )
                    )

        return findings
